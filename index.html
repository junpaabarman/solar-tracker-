from flask import Flask, jsonify, request, send_from_directory
import joblib
import tensorflow as tf
import pandas as pd
import numpy as np
import os
from flask_cors import CORS

# Custom loss function for the ANN model
def mse(y_true, y_pred):
    return tf.keras.losses.mean_squared_error(y_true, y_pred)

# Initialize Flask app
app = Flask(__name__)
CORS(app)

# Load the ANN model and the scaler
print("Loading model and scaler...")
model = tf.keras.models.load_model('ANN_model.h5', custom_objects={'mse': mse})
scaler = joblib.load('scaler.pkl')
print("Model and scaler loaded successfully.")

def predict_tilt_angle(month, day, hour, temperature, humidity, ghi):
    try:
        # Create a DataFrame with the input values
        input_data = pd.DataFrame({
            'Month': [month],
            'Day': [day],
            'Hour': [hour],
            'Temperature': [temperature],
            'Relative Humidity': [humidity],
            'GHI': [ghi]
        })
        
        # Ensure the input data has the same feature names as used during training
        expected_features = ['Month', 'Day', 'Hour', 'Temperature', 'Relative Humidity', 'GHI']
        input_data = input_data.reindex(columns=expected_features, fill_value=0)
        
        # Scale the input data
        input_scaled = scaler.transform(input_data.values)
        
        # Predict the tilt angle using the ANN model
        predicted_tilt_angle = model.predict(input_scaled)[0][0]
        
        # Adjust the predicted angle based on the time of day (for tilt optimization)
        if 7 <= hour < 13:
            predicted_tilt_angle = -predicted_tilt_angle
        
        return float(predicted_tilt_angle)
    except Exception as e:
        print(f"Error in prediction: {e}")
        return None

# Serve the static home page (index.html)
@app.route('/')
def home():
    return send_from_directory(os.getcwd(), 'index.html')

# Prediction route
@app.route('/predict', methods=['GET'])
def predict():
    try:
        # Retrieve query parameters
        month = request.args.get('month', type=int)
        day = request.args.get('day', type=int)
        hour = request.args.get('hour', type=int)
        temperature = request.args.get('temperature', type=float)
        humidity = request.args.get('humidity', type=float)
        ghi = request.args.get('ghi', type=float)
        
        # Check for missing parameters
        if None in (month, day, hour, temperature, humidity, ghi):
            return jsonify({'error': 'Missing or invalid query parameters'}), 400
        
        # Predict the tilt angle
        tilt_angle = predict_tilt_angle(month, day, hour, temperature, humidity, ghi)
        
        if tilt_angle is None:
            return jsonify({'error': 'Error in prediction'}), 500
        
        return jsonify({'angle': tilt_angle})
    except Exception as e:
        print(f"Error in /predict endpoint: {e}")
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    # Use the PORT environment variable if available (for Render.com compatibility)
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
